args: {
	// The user credentials to be set
	postgresUser: "admin"

	postgresDb: "acorn"

	// It can be used to send arguments to postgres initdb
	// This is useful for adding functionality like "--data-checksums"
	postgresInitDbArgs: ""

	// It can be used to define another location for the Postgres transaction log.
	postgresInitDbWalDir: ""

	postgresHostAuthMethod: ""

	// It can be used to define location for the database files
	pgData: "/var/lib/postgresql/data"

	// Backup Schedule
	backupSchedule: "@hourly"

	// Restore from Backup. Takes a backup file name
	restoreFromBackup: ""
}

containers: {
	postgresql: {
		image:  "postgres:14.5-bullseye"
		ports: {
			internal: [
               //prometheus monitoring
				"9187:9187"
			]
			expose: "5432:5432"
		}
		env: {
			"POSTGRES_PASSWORD": "secret://root-credentials/password"
			"POSTGRES_USER": "secret://root-credentials/username"
			"POSTGRES_DB": "\(args.postgresDb)"
			"POSTGRES_INITDB_ARGS": "\(args.postgresInitDbArgs)"
			"POSTGRES_INITDB_WALDIR": "\(args.postgresInitDbWalDir)"
			"POSTGRES_HOST_AUTH_METHOD": "\(args.postgresHostAuthMethod)"
			"PGDATA": "\(args.pgData)"
		}
		dirs: {
			"\(args.pgData)": "volume://pgdata-0"
			"/backup": "volume://backup"
		}
	}
}

secrets: {
	"root-credentials": {
		type: "basic"
		data: {
			username: "\(args.postgresUser)"
		}
	}
}

volumes: {
	"pgdata-0": {}
	"backup": {}
}

if args.backupSchedule != "" {
	jobs: {
		"backup": {
			image: "postgres:14.5-bullseye"
			dirs: {
				"/acorn/scripts": "./scripts"
				"/backup": "volume://backup"
			}
			command: ["sh","/acorn/scripts/backup.sh"]
			env: {
				"POSTGRES_USER":     "secret://root-credentials/username"
				"POSTGRES_PASSWORD": "secret://root-credentials/password"
				"POSTGRES_DB": "\(args.postgresDb)"
			}
			schedule: "@hourly"
		}
	}
}